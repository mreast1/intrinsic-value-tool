export default async function handler(req, res) { res.setHeader("Access-Control-Allow-Origin", "*"); const symbol = req.query.symbol; if (!symbol) { return res.status(400).json({ error: "Symbol required" }); } /* --------- 1️⃣ TRY YAHOO FIRST --------- */ try { const yahooUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}.NS` + `?modules=price,defaultKeyStatistics`; const yahooRes = await fetch(yahooUrl, { headers: { "User-Agent": "Mozilla/5.0", "Accept": "application/json" } }); const yahooText = await yahooRes.text(); if (yahooText.startsWith("{")) { const yahooJson = JSON.parse(yahooText); const result = yahooJson?.quoteSummary?.result?.[0]; const price = result?.price?.regularMarketPrice?.raw; const eps = result?.defaultKeyStatistics?.trailingEps?.raw; if (price && eps) { return res.status(200).json({ price, eps, source: "yahoo" }); } } } catch (e) { // silently fail → fallback } /* --------- 2️⃣ FALLBACK: ALPHA VANTAGE --------- */ try { const API_KEY = process.env.ALPHA_VANTAGE_KEY; const url = `https://www.alphavantage.co/query?function=OVERVIEW` + `&symbol=${symbol}.NSE&apikey=${API_KEY}`; const avRes = await fetch(url); const avJson = await avRes.json(); if (!avJson.EPS || !avJson.AnalystTargetPrice) { return res.status(500).json({ error: "Alpha Vantage data unavailable" }); } return res.status(200).json({ price: Number(avJson.AnalystTargetPrice), eps: Number(avJson.EPS), source: "alpha-vantage" }); } catch (err) { return res.status(500).json({ error: "Both data sources failed" }); } }
