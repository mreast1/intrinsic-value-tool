export default async function handler(req, res) { res.setHeader("Access-Control-Allow-Origin", "*"); const symbol = req.query.symbol; if (!symbol) { return res.status(400).json({ error: "Symbol is required" }); } try { const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}.NS` + `?modules=price,defaultKeyStatistics`; const response = await fetch(url, { headers: { "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36", "Accept": "application/json", "Accept-Language": "en-US,en;q=0.9" } }); const text = await response.text(); // Yahoo returned HTML or error text if (!text.startsWith("{")) { return res.status(500).json({ error: "Yahoo blocked the request", raw: text.slice(0, 100) }); } const json = JSON.parse(text); const result = json?.quoteSummary?.result?.[0]; if (!result) { return res.status(404).json({ error: "Stock data not found" }); } const price = result.price?.regularMarketPrice?.raw; const eps = result.defaultKeyStatistics?.trailingEps?.raw; if (!price || !eps) { return res.status(200).json({ price: price || 0, eps: eps || 0, warning: "EPS or price missing" }); } return res.status(200).json({ price, eps }); } catch (err) { return res.status(500).json({ error: "Backend crashed", message: err.message }); } }
